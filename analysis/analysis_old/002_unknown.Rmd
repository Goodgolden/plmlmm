---
title: "11_outline"
author: "randy"
date: "2022-07-01"
output: html_document
---


```{r}
knitr::opts_chunk$set(echo = TRUE)
# load_all("/Users/goodgolden5/Documents/PMMSKNN")
```


```{r}
library("tidyverse")
library("magrittr")
library("gamlss")
library("brokenstick")
library("rjags")
library("JMbayes")
library("splines")

library("lme4")
library("nlme")
library("splines")

library(data.table)
```


```{r}
load("data/epic_randy_train_test.Rdata")
# train <- here::here("data", 
#                     "epic_randy_train_test.csv") %>%
#   read.csv(row.names = 1) %>% 
#   mutate(id = as.factor(id)) %>%
#   filter(group == "training")
# 
# test <- here::here("data", 
#                    "epic_randy_train_test.csv") %>%
#   read.csv(row.names = 1) 

base_test <- test %>% 
  group_by(id) %>% 
  arrange(time) %>% 
  slice(1L) 

base_train <- test %>% 
  group_by(id) %>% 
  arrange(time) %>% 
  slice(1L) 

train_info <- train %>% 
  dplyr::select(id, sex, time, genotype)
```


```{r}
ctrl <- lmeControl(opt = 'optim')
fit1 <-  lme(ht ~ bs(time,
                     knots = c(10, 12, 15), 
                     degree = 3) * sex - 1,
              random = ~ 1 + time| id,
              control = ctrl,
              data = train)

fit1.5 <-  lme(ht ~ bs(time,
                     degree = 3) * sex - 1,
              random = ~ 1 + time| id,
              control = ctrl,
              data = train)


fit2 <-  lme(ht ~ bs(time,
                     knots = c(10, 12, 15), 
                     degree = 3) * sex - 1,
              random = ~ 1 + bs(time, 3)| id,
              control = ctrl,
              data = train)


fit2 <-  lme(ht ~ bs(time,
                     knots = c(10, 12, 15), 
                     degree = 3) * sex - 1,
              random = ~ 1 + bs(time, 3)| id,
              control = ctrl,
              data = train)


# broom.mixed::augment(fit2)
attr(bs(train$time, df = 7), "knots")
range(train$time)
```


```{r}
summary(fit1); summary(fit2)

tidy1 <- broom.mixed::tidy(fit1); tidy1

broom.mixed::glance(fit1) ## 182507.1	
broom.mixed::glance(fit2) ## 156041.5

## contrasts are not very useful in this case.
contrast_f <- c(1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0)
contrast_m <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)
```



```{r}
# View(train_info)
theta <- fit1$coefficients$fixed
## fix variance covariance
(Sigma <- vcov(fit1) %>% as.matrix())
## residuals standard error
(sigma <- fit1$sigma)
(D <- getVarCov(fit1))


## fixed and random coefficients
broom.mixed::tidy(fit1, "fixed")
broom.mixed::tidy(fit1, "ran_pars")
broom.mixed::tidy(fit1)

ranef(fit1)
ranef(fit2)
```


```{r}
genSpline <- function(subset,
                      # knots = c(2.75, 5.43, 8.69), 
                      # degree = 3, 
                      theta = coef) {
  
  # subset <- id103125
  # # View(subset)
  theta <- fit1$coefficients$fixed
  time = subset$time
  gender = unique(subset$sex); gender
  # knots = c(10, 12, 15)
  # degree = 3
  contrast_f <- c(1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0)
  contrast_m <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)
  ## fitime coefficients
    if (gender == "M") {
      fit1 * contrast_f
  } else {
    theta <- theta_f
  }
  
  basis <- bs(x = time, 
              degree = degree,
              knots = knots)
  # View(id103125)
  
  y.spline <- basis %*% theta
  
  dt <- data_frame(time, y.spline = as.vector(y.spline))
  
  return(fixed = dt)
}

id103125 <- train_info %>% filter(id == "103125")
genSpline(id103125)
```



```{r}
broom.mixed::tidy(fit2)

(coef2 <- fit2$coefficients$fixed)
(rand2 <- fit2$coefficients$random)
(sigma2 <- fit2$sigma)
(vcov2 <- getVarCov(fit2))

fixed2 <- train_info %>%
   group_by(id) %>% 
   group_map(~genSpline(subset = .), .keep = TRUE) %>%
   map("y.spline") %>%
  unlist()

bran2 <- mvrnorm(n = length(unique(train$id)), 
                 mu = c(0, 0, 0, 0), 
                 Sigma = vcov2) %>%
  round(2) %>%
  cbind(id = unique(as.character(train$id)), .) %>%
  as.data.frame()

train_info_df2 <- train_info %>%
  group_by(id) %>%
  group_map(~dplyr::select(., time))


View(bran2)
View(train_info_df2)


random2 <- map2(train_info_df2, bran2, 
                ~genSpline(subset = .x, 
                           knots = c(2.75, 5.43, 8.69),
                           coef))
```




```{r}
random <- list()

for (i in bran1$id) {
  train_sub <-  train_info %>% 
    filter(id == i) %>%
    mutate(int = 1) %>%
    dplyr::select(int, time) %>%
    as.matrix()
  
  bran <- bran1 %>%
    filter(id == i) %>%
    dplyr::select(`(Intercept)`, time) %>%
    as.matrix()

  random[i] <-  t(bran) %*% as.matrix(train_sub) 
}

train_simu <- train_info %>%
  mutate(fixed = fixed1) %>% 
  full_join(bran1, by = "id")

View(train_simu)
```


the documents 



```{r}
# library(mgcv)
# gam1 <- gam(ht ~ s(time, bs = "cr") + 
#                  s(id, bs = "re") + genotype + sex,
#               data = train)

# pre_test<- predict(object = fit1, 
#                    new_data = train,
#                    x = c(10, 12, 15))

## right now ignore the test dataset
# bks_cp <- data.frame(predict = pre_test,
#                      test = test$ht)

# fit1_light <- extract_lmeComponents(fit1, timeVar = "time")
# fit1_light


test_baseline <- basetest %>%
  dplyr::select(id, sex, time, ht, age, genotype)

# names(test_baseline)
time_vec <- c(1:17)


?IndvPred_lme
lmm_pred1 <- 
  IndvPred_lme(fit1,
    newdata = test_baseline,
    timeVar = "time",
    M = 500,
    # times = time_vec,
    all_times = TRUE,
    return_data = TRUE,
    level = 0.5,
    # interval = "prediction",
    seed = 555)


lmm_pred2 <- 
  IndvPred_lme(fit2,
    newdata = test_baseline,
    timeVar = "time",
    M = 500,
    # times = time_vec,
    all_times = TRUE,
    return_data = TRUE,
    level = 0.5,
    # interval = "prediction",
    seed = 555)

lmm_pred
lmm_pred2
```

V = ZGZ + R



```{r}
## plot.basis -------------------------------------------------------
plot.basis <- function(basisdata) {
  dtbasis <- as.data.table(basisdata$basis)
  dtbasis[, x := seq(0, 1, length.out = .N)]
  dtmelt <- melt(
    data = dtbasis, id = "x",
    variable.name = "basis", variable.factor = TRUE
  )

  ggplot(data = dtmelt, 
         aes(x = x, y = value, group = basis)) +
    geom_line(aes(color = basis), size = 1) +
    theme(legend.position = "none") +
    scale_x_continuous(
      limits = c(0, 1),
      breaks = c(0, basisdata$knots, 1)
    ) +
    theme(panel.grid.minor = element_blank())
}

## plot spline ---------------------------------------------------------
plot.spline <- function(basisdata, points = FALSE) {

    p <- ggplot(data = basisdata$dt)
    
    if (points) p <- p +
        geom_point(aes(x = x, y = y), color = "grey75")  
      
    p <- p + 
      geom_line(aes(x = x, y = y.spline), color = "red", size = 1) +
      # scale_y_continuous(limits = c(0, 1)) +
      # scale_x_continuous(limits = c(0, 1), breaks = knots) +
      theme(panel.grid.minor = element_blank())
       
   return(p)
  
}

```



```{r}
x <- seq(0, 17, length.out = 100)
knots <- c(10, 12, 15)

sd(unlist(fit1$coefficients$random))
# mean(unlist(fit1$coefficients$random))


## plot of the Bsplines
sdata <- genSpline(x, knots, 3, theta) 
plot.basis(sdata)
plot(sdata$dt$x, sdata$dt$y.spline)
plot.spline(sdata)



## simulation of dataset

library(mvtnorm)
?rmvnorm

sdata$dt
sim_data <- mvtnorm::rmvnorm(50, mean = sdata$dt$y.spline, sigma = sdata$V)
matplot(sdata$dt$x, t(sim_data), 
          xlab = "input, x", 
          ylab = "output, y",
          "l")

mvtnorm (mean, Sigma)
```
sample size training 900 and testing 450 

observed subjects true time points:
conditional on the time (observed) and random effects (based on those time), then simulated data. 
only at observed time points for given individuals


20 times for datasets:  


1. table1 & table0



2. a graph? flow chart for:

  - plm: 
    - L2 vs Mahalanobius
    - pvalue vs fixed
    - single vs multiple time
    
  - lmm: dynamic prediction with library("JMbayes")
  
  
3. raw data presentation
  - abascus plot
  - beginning age: distribution
  - follow-up time: distribution
  - sample trajectories



4. lmm trajectory
  - fitted???
  

5. plm trajectory and matching 
   for each situations 


6. simulation 
  - with which models plm or lmm
  - different ss 1000 simulations: N = 100, N = 1000 
  - different noise/signal ratio: sigma change over time

















