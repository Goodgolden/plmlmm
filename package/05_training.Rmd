


```{r}
library(tidyverse)
library(doParallel)
library(foreach)
library(tictoc)

library(plmlmm)
# devtools::load_all()

load("Z:/plmlmm/package/plmlmm_simulation_1k_dataset_20220821.Rdata")
```


```{r}
detectCores()
myCluster <- makeCluster(20, # number of cores to use
                         type = "PSOCK") # type of cluster

registerDoParallel(myCluster)
```





```{r}

timea <- Sys.time()

output <- foreach(i = 1:20, 
                  .export = ls(globalenv()), 
                  .packages = c("plmlmm", "tidyverse", "gamlss", "brokenstick")) %dopar% {
  
  
    .GlobalEnv$simulation_1k <- simulation_1k
    `%!in%` <- Negate(`%in%`)
    
    
    library(plmlmm)
    
    train_data <- dplyr::filter(simulation_1k[[i]], group == "training")
    id_train <- unique(train_data$id)

    
    bks_pred <- 
     plmlmm::brokenstick_prediction(
        outcome = "ht",
        time = "time",
        id = "id",
        train_data = train_data,
        knots = c(5, 10, 12),
        pred_time = c(2, 4, 6, 8, 10, 12),
        # newdata = test_baseline,
        choice = "predicted")
    
    lb_data <- 
      plmlmm::linear_brokenstick(
        lm_formula = "`.pred` ~ time * sex + baseline",
        bks_pred = bks_pred)

    
    eld_p09 <-   map(id_train, 
                             ~plmlmm::pred_matching(
                              lb_data = lb_data,
                              obs_data = train_data,
                              match_methods = "euclidean",
                              match_num = 30,
                              gamlss_formula = "ht ~ cs(time, df = 3)",
                              gamsigma_formula = "~ cs(time, df = 1)",
                              match_plot = TRUE,
                              predict_plot = TRUE,
                              sbj = .))
  
    mhl_p09 <-   map(id_train, 
                        ~plmlmm::pred_matching(
                          lb_data = lb_data,
                          obs_data = train_data,
                          match_methods = "mahalanobis",
                          match_alpha = 0.95,
                          gamlss_formula = "ht ~ cs(time, df = 3)",
                          gamsigma_formula = "~ cs(time, df = 1)",
                          match_plot = TRUE,
                          predict_plot = TRUE,
                          sbj = .))
    
  
    mhl_n10 <-   map(id_train, 
                        ~plmlmm::pred_matching(
                          lb_data = lb_data,
                          obs_data = train_data,
                          match_methods = "mahalanobis",
                          match_num = 10,
                          gamlss_formula = "ht ~ cs(time, df = 3)",
                          gamsigma_formula = "~ cs(time, df = 1)",
                          match_plot = TRUE,
                          predict_plot = TRUE,
                          sbj = .))
  
    sgl10_n10 <-   map(id_train, 
                        ~plmlmm::pred_matching(
                          lb_data = lb_data,
                          obs_data = train_data,
                          match_methods = "single",
                          match_num = 10,
                          match_time = 10,
                          match_alpha = NULL,
                          gamlss_formula = "ht ~ cs(time, df = 3)",
                          gamsigma_formula = "~ cs(time, df = 1)",
                          match_plot = TRUE,
                          predict_plot = TRUE,
                          sbj = .))
  
    
    
    plmm_res <- list(eld_p09, mhl_n10, mhl_p09, sgl10_n10)
    
    plmm_res
}

# save(plmm_res, file = "plmlmm_simulation_dataset1_results.Rdata")
  
  
stopCluster(myCluster)
timeb <- Sys.time()
```



```{r}
timeb - timea
```

